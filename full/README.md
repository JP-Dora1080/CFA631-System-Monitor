# CFA631 LCD Setting System simple-v1.1
for HomeDC Japan

> Crystalfontz 20×2 LCD（CFA631-USB）の電源投入時表示を  
> 設定ファイルベースで簡単に設定するツール

## ✨ 特長
* **設定ファイルベース**: `config.yml` で表示内容を簡単設定
* **EEPROM保存**: 設定内容を不揮発性メモリに保存
* **電源投入時復元**: 次回電源投入時に自動的に設定内容を表示
* **自動設定ファイル生成**: 設定ファイルがない場合は自動生成
* **リブート機能**: 設定確認のためのシステムリブート機能

## 🔧 ファイル構成

```
.
├─ cfa631_setting.py    # メインスクリプト
└─ config.yml          # 設定ファイル（無ければ自動で生成）
```

### config.yml 例

```yaml
# CFA631 Display Configuration
display:
  line1:
    text: 'Default Line1'    # 1行目に表示するテキスト
  line2:
    text: 'Default Line2'    # 2行目に表示するテキスト

system:
  port: '/dev/ttyUSB0'       # CFA631 が刺さるデバイス
  baudrate: 115200           # デフォルト115200
  backlight: 100             # 0–100 %
```

## 🚀 使い方

1. **必要なライブラリのインストール**
   ```bash
   pip install pyserial pyyaml
   ```

2. **スクリプトに実行権を付与**  
   ```bash
   chmod +x cfa631_setting.py
   ```

3. **デバイス名を確認**  
   ```bash
   ls /dev/ttyUSB*
   # または
   dmesg | grep tty
   ```

4. **設定ファイルの編集**
   ```bash
   nano config.yml
   ```
   表示したいテキストを設定してください。

5. **実行**  
   ```bash
   python3 cfa631_setting.py
   ```

   起動すると以下のようなバナーが表示されます：

```
╔══════════════════════════════════════════════════════════╗
║         CFA631 LCD Setting System simple-v1.1            ║
║                   for HomeDC Japan                       ║
╠══════════════════════════════════════════════════════════╣
║  作成者    : Veulx                                       ║
║  バージョン: simple-v1.1                                 ║
║  作成日    : 2025-07-02                                  ║
║  説明      : CFA631 LCD用システム監視ツール              ║
╚══════════════════════════════════════════════════════════╝
⚙️  設定ファイルを読み込み中...
=== 設定情報 ===
📝 1行目テキスト: Default Line1
📝 2行目テキスト: Default Line2
🔌 シリアルポート: /dev/ttyUSB0
📡 ボーレート: 115200
💡 バックライト: 100%

🔗 CFA631に接続中...
```

## 🔄 プログラムの動作

1. **設定ファイル読み込み**
   - `config.yml` が存在しない場合は自動生成
   - 設定内容を画面に表示

2. **CFA631接続**
   - 指定されたシリアルポートに接続
   - 通信パラメータを設定

3. **表示設定**
   - バックライト設定
   - ディスプレイクリア
   - 1行目・2行目にテキスト表示

4. **EEPROM保存**
   - 現在の表示状態を電源投入時の状態として保存
   - 次回電源投入時に自動復元

5. **リブート確認**
   - オプションでシステムリブートして設定確認

## 📋 設定項目詳細

### display セクション
| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| `line1.text` | 1行目表示テキスト | `'Default Line1'` |
| `line2.text` | 2行目表示テキスト | `'Default Line2'` |

### system セクション
| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| `port` | シリアルポート | `'/dev/ttyUSB0'` |
| `baudrate` | ボーレート | `115200` |
| `backlight` | バックライト明度（0-100%） | `100` |

## 💡 使用例

### 例1: 基本的な表示設定
```yaml
display:
  line1:
    text: 'HomeDC Japan'
  line2:
    text: 'Server Status OK'

system:
  port: '/dev/ttyUSB0'
  baudrate: 115200
  backlight: 80
```

### 例2: サーバー情報表示
```yaml
display:
  line1:
    text: 'Web Server'
  line2:
    text: 'Running on Port 80'

system:
  port: '/dev/ttyUSB1'
  baudrate: 115200
  backlight: 100
```

## 🛠️ 機能詳細

### EEPROM保存機能
- `store_current_state_as_boot_state()`: 現在の表示状態を電源投入時の状態として保存
- 電源を切っても設定が保持される
- 次回電源投入時に自動的に同じ内容が表示される

### リブート機能
- `reboot()`: CFA631システムをリブート
- 設定が正しく保存されているかの確認に使用
- マニュアル仕様に準拠した安全なリブート

### 自動設定ファイル生成
- 初回実行時に `config.yml` が自動生成される
- デフォルト値が設定済み
- すぐに使用開始可能

## 💡 トラブルシューティング

| 症状 | 対処 |
|------|------|
| LCD が無反応 | `dmesg \| grep tty` でデバイス名を確認し、`config.yml` の `port` を変更 |
| Permission denied | `sudo usermod -aG dialout $USER` 後ログインし直し |
| 設定ファイル読み込みエラー | YAML形式が正しいか確認（インデントに注意） |
| 文字化け | ASCII文字のみ対応。全角文字は「?」に置換される |
| EEPROM保存失敗 | 書き込み完了まで十分な時間を確保（1.5秒待機） |

## 🔄 バージョン履歴

### simple-v1.1 (2025-07-02)
- 初回リリース
- 設定ファイルベースの表示設定
- EEPROM保存機能
- 自動設定ファイル生成
- システムリブート機能

## 📝 注意事項

- **文字制限**: 各行最大20文字（ASCII文字のみ）
- **EEPROM書き込み**: 頻繁な書き込みは避けてください
- **電源投入時復元**: 設定後は電源を切っても内容が保持されます
- **リブート機能**: 設定確認以外では使用を控えてください

## 🎯 用途例

- **サーバー状態表示**: サーバー名とステータス
- **ネットワーク機器**: 機器名とIP情報
- **組込みシステム**: システム名とバージョン
- **監視システム**: 監視対象名と状態